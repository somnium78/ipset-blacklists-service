#!/bin/bash

# ipset Blacklist Status Script
# Shows current status and statistics

IPSET_NAME="blacklist_inbound"
WORK_DIR="/var/lib/ipset-blacklist"
LOG_FILE="/var/log/ipset-blacklist.log"

echo "=== ipset Blacklist Service Status ==="
echo "Date: $(date)"
echo

# Check ipset
if ipset list "$IPSET_NAME" >/dev/null 2>&1; then
    entries=$(ipset list "$IPSET_NAME" | grep "Number of entries" | awk '{print $4}')
    echo "✅ ipset $IPSET_NAME: $entries entries"

    # Show sample entries
    echo "Sample entries:"
    ipset list "$IPSET_NAME" | head -5 | grep -E '^[0-9]' | while read -r ip; do
        echo "  $ip"
    done
else
    echo "❌ ipset $IPSET_NAME: NOT FOUND"
fi

echo

# Check iptables rules
if iptables -C INPUT -m set --match-set "$IPSET_NAME" src -j DROP 2>/dev/null; then
    echo "✅ iptables rule: Active in INPUT chain"
else
    echo "❌ iptables rule: NOT FOUND"
fi

echo

# Check files
echo "=== Files Status ==="
if [[ -f "$WORK_DIR/blacklist_current.txt" ]]; then
    current_entries=$(wc -l < "$WORK_DIR/blacklist_current.txt")
    echo "✅ Current list: $current_entries entries"
else
    echo "❌ Current list: NOT FOUND"
fi

if [[ -f "$LOG_FILE" ]]; then
    log_size=$(du -h "$LOG_FILE" | cut -f1)
    last_update=$(tail -1 "$LOG_FILE" 2>/dev/null | cut -d: -f1-2)
    echo "✅ Log file: $log_size (last: $last_update)"
else
    echo "❌ Log file: NOT FOUND"
fi

echo

# Show recent log entries
echo "=== Recent Log Entries ==="
if [[ -f "$LOG_FILE" ]]; then
    tail -5 "$LOG_FILE" 2>/dev/null | while read -r line; do
        echo "  $line"
    done
else
    echo "  No log file found"
fi

echo
echo "=== Service Status Complete ==="
