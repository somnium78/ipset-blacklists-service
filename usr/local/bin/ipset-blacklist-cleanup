#!/bin/bash

# ipset Blacklist Cleanup Script
# Removes all ipsets, iptables rules, and data files

IPSET_NAME="blacklist_inbound"
WORK_DIR="/var/lib/ipset-blacklist"
TEMP_DIR="/tmp/ipset-blacklist"

echo "$(date): === Starting ipset Blacklist Cleanup ==="

# Remove iptables rules
echo "$(date): Removing iptables rules..."
iptables -D INPUT -m set --match-set "$IPSET_NAME" src -j DROP 2>/dev/null && echo "$(date): Removed INPUT rule" || echo "$(date): INPUT rule not found"
iptables -D FORWARD -m set --match-set "$IPSET_NAME" src -j DROP 2>/dev/null && echo "$(date): Removed FORWARD rule" || echo "$(date): FORWARD rule not found"

# Remove ipset
if ipset list "$IPSET_NAME" >/dev/null 2>&1; then
    echo "$(date): Removing ipset $IPSET_NAME..."
    ipset destroy "$IPSET_NAME" 2>/dev/null && echo "$(date): ipset $IPSET_NAME removed" || echo "$(date): Failed to remove ipset"
else
    echo "$(date): ipset $IPSET_NAME not found"
fi

# Remove work files
echo "$(date): Removing work files..."
if [[ -d "$WORK_DIR" ]]; then
    rm -rf "$WORK_DIR"/* 2>/dev/null
    echo "$(date): Cleaned work directory: $WORK_DIR"
else
    echo "$(date): Work directory not found: $WORK_DIR"
fi

# Remove temp files
echo "$(date): Removing temp files..."
if [[ -d "$TEMP_DIR" ]]; then
    rm -rf "$TEMP_DIR"/* 2>/dev/null
    echo "$(date): Cleaned temp directory: $TEMP_DIR"
else
    echo "$(date): Temp directory not found: $TEMP_DIR"
fi

# Show final status
echo "$(date): === Cleanup Summary ==="
echo "$(date): ipset status: $(ipset list "$IPSET_NAME" >/dev/null 2>&1 && echo "EXISTS (ERROR!)" || echo "REMOVED")"
echo "$(date): iptables rules: $(iptables -L INPUT | grep -q "$IPSET_NAME" && echo "EXISTS (ERROR!)" || echo "REMOVED")"
echo "$(date): Work files: $(ls -la "$WORK_DIR"/ 2>/dev/null | wc -l) files remaining"
echo "$(date): Temp files: $(ls -la "$TEMP_DIR"/ 2>/dev/null | wc -l) files remaining"

echo "$(date): === Cleanup completed - ready for fresh start ==="
